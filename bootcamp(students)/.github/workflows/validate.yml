name: Validate Security Lab Flag

on:
  issues:
    types: [opened]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Validate Flag Submission
        env:
          FLAG_Q1: ${{ secrets.FLAG_Q1 }}
          FLAG_Q2: ${{ secrets.FLAG_Q2 }}
          FLAG_Q3: ${{ secrets.FLAG_Q3 }}
          FLAG_Q4: ${{ secrets.FLAG_Q4 }}
        run: |
          python3 - <<'EOF'
          import json, re, os, sys

          event = json.load(open(os.environ["GITHUB_EVENT_PATH"]))
          body = event["issue"]["body"]

          challenge_match = re.search(r"Challenge:\s*(Q\d)", body)
          flag_match = re.search(r"Flag:\s*(SMC\{[^\}]+\})", body)

          if not challenge_match or not flag_match:
              print("❌ Invalid issue format")
              sys.exit(1)

          challenge = challenge_match.group(1)
          submitted = flag_match.group(1)

          expected = os.environ.get(f"FLAG_{challenge}")

          if not expected:
              print("❌ Flag not configured")
              sys.exit(1)

          if submitted == expected:
              print("✅ VALID FLAG – ENTRY ACCEPTED")
          else:
              print("❌ INVALID FLAG")
              sys.exit(1)
          EOF
